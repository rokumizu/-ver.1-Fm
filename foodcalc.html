<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ „é¤Šã‚«ãƒ­ãƒªãƒ¼è¨ˆç®—ã‚½ãƒ•ãƒˆ</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4faff;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #0077cc;
      margin-bottom: 20px;
    }
    .grid, .edit-grid {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 40px;
    }
    .category {
      flex: 1;
      min-width: 250px;
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .category h2 {
      text-align: center;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
      margin-bottom: 15px;
    }
    .card, .edit-card {
      margin-bottom: 15px;
    }
    .card label, .edit-card label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .card input, .edit-card input, .edit-card select {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .result {
      font-size: 14px;
      margin-top: 5px;
      background: #eef;
      padding: 5px;
      border-radius: 6px;
    }
    .summary, .warning, #target {
      text-align: center;
      margin-top: 20px;
      font-size: 16px;
    }
    .warning {
      color: red;
      font-weight: bold;
      white-space: pre-line;
    }
    .controls {
      max-width: 500px;
      margin: 0 auto 20px;
      text-align: center;
    }
    .controls select, .controls button {
      padding: 8px;
      font-size: 14px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    /* ã‚¹ãƒãƒ›ç‰ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 600px) {
      .controls, .grid, .edit-grid {
        flex-direction: column;
        align-items: center;
      }
      .category {
        min-width: 100%;
      }
    }

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .popup-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      text-align: center;
    }
    .popup-content input, .popup-content select {
      margin: 10px 0;
      width: 100%;
    }
    .popup-content button {
      background: #0077cc;
      color: #fff;
      padding: 10px;
      border: none;
      width: 100%;
      border-radius: 6px;
    }
    .popup-content button:hover {
      background: #005fa3;
    }

    .food-action-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .food-action-buttons button {
      padding: 5px;
      font-size: 12px;
      width: 48%;
    }

    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
    .back-button {
      display: inline-block;
      margin: 20px auto 0;
      padding: 6px 14px;
      font-size: 13px;
      background-color: #ccc;
      color: #333;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .back-button:hover {
      background-color: #bbb;
    }
  </style>
</head>
<body>

<h1>ğŸ± æ „é¤Šã‚«ãƒ­ãƒªãƒ¼è¨ˆç®—ã‚½ãƒ•ãƒˆ</h1>

<div class="controls">
  <label for="userSelect">ğŸ¯ PFCç›®æ¨™ã‚’é¸æŠ:</label>
  <select id="userSelect" onchange="loadUserData()">
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
  </select>
  <div id="target">ğŸ¯ ç›®æ¨™æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼: 0 kcalï½œP: 0 gï½œF: 0 gï½œC: 0 g</div>
</div>

<!-- ğŸ§¾ é£Ÿæç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<h2 style="text-align:center;">âœï¸ é£Ÿæç·¨é›†</h2>
<div class="edit-grid" id="edit-grid"></div>
<div class="controls">
  <button onclick="openPopup()">ï¼‹ é£Ÿæã‚’è¿½åŠ </button>
    <button onclick="resetFoods()">ğŸ”„ å…¨ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- ğŸ§® é£Ÿæå…¥åŠ›ã‚¨ãƒªã‚¢ -->
<h2 style="text-align:center;">ğŸ¥— é£Ÿæå…¥åŠ›</h2>
<div class="grid" id="food-grid"></div>

<!-- âœ… çµæœè¡¨ç¤º -->
<div class="summary" id="summary">
  âœ… ç·æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼: 0 kcalï½œP: 0 gï½œF: 0 gï½œC: 0 g
</div>
<div class="warning" id="warning"></div>

<!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ  -->
<div id="foodPopup" class="popup">
  <div class="popup-content">
    <h3>é£Ÿæã‚’è¿½åŠ </h3>
    <label for="foodName">åå‰</label>
    <input type="text" id="foodName" placeholder="é£Ÿæåã‚’å…¥åŠ›" required>

    <label for="foodKcal">kcal/g</label>
    <input type="number" id="foodKcal" step="0.01" required>

    <label for="foodP">P/g</label>
    <input type="number" id="foodP" step="0.01" required>

    <label for="foodF">F/g</label>
    <input type="number" id="foodF" step="0.01" required>

    <label for="foodC">C/g</label>
    <input type="number" id="foodC" step="0.01" required>

    <label for="foodCategory">ã‚«ãƒ†ã‚´ãƒª</label>
    <select id="foodCategory">
      <option value="P">ã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼ˆPï¼‰</option>
      <option value="F">è„‚è³ªï¼ˆFï¼‰</option>
      <option value="C">ç‚­æ°´åŒ–ç‰©ï¼ˆCï¼‰</option>
    </select>

    <button onclick="addFoodToList()">è¿½åŠ </button>
    <button onclick="closePopup()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<script>
  let targets = { protein: 120, fat: 50, carb: 200 };

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  function loadUserData() {
    const selectedUser = document.getElementById("userSelect").value;
    const users = JSON.parse(localStorage.getItem("pfcAllUsers") || "{}");
    const targetElement = document.getElementById("target");

    if (selectedUser && users[selectedUser]) {
      const user = users[selectedUser];
      targetElement.textContent = `ğŸ¯ ç›®æ¨™æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼: ${user.intake} kcalï½œP: ${user.proteinAvg} gï½œF: ${user.fatGram} gï½œC: ${user.carbGram} g`;
    } else {
      targetElement.textContent = "ğŸ¯ ç›®æ¨™æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼: 0 kcalï½œP: 0 gï½œF: 0 gï½œC: 0 g";
    }
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆã‚’æ›´æ–°
  function updateUserSelect() {
    const users = JSON.parse(localStorage.getItem("pfcAllUsers") || "{}");
    const userSelect = document.getElementById("userSelect");
    userSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    for (const user in users) {
      const option = document.createElement("option");
      option.value = user;
      option.textContent = user;
      userSelect.appendChild(option);
    }
  }

  function openPopup() {
    document.getElementById("foodPopup").style.display = "flex";
  }

  function closePopup() {
    document.getElementById("foodPopup").style.display = "none";
  }

  // é£Ÿå“è¿½åŠ 
  function addFoodToList() {
    const name = document.getElementById("foodName").value;
    const kcal = parseFloat(document.getElementById("foodKcal").value);
    const p = parseFloat(document.getElementById("foodP").value);
    const f = parseFloat(document.getElementById("foodF").value);
    const c = parseFloat(document.getElementById("foodC").value);
    const category = document.getElementById("foodCategory").value;

    if (name && !isNaN(kcal) && !isNaN(p) && !isNaN(f) && !isNaN(c)) {
      const newFood = { name, kcal, p, f, c, category };
      const foods = JSON.parse(localStorage.getItem("foodItems") || "[]");
      foods.push(newFood);
      localStorage.setItem("foodItems", JSON.stringify(foods));
      closePopup();
      loadFoods();
    } else {
      alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
    }
  }

  // é£Ÿå“ãƒªã‚¹ãƒˆè¡¨ç¤º
  function loadFoods() {
    const foods = JSON.parse(localStorage.getItem("foodItems") || "[]");
    const categories = { "P": [], "F": [], "C": [] };
    foods.forEach(item => {
      categories[item.category].push(item);
    });

    const foodGrid = document.getElementById("food-grid");
    foodGrid.innerHTML = "";
    Object.keys(categories).forEach(category => {
      const categoryDiv = document.createElement("div");
      categoryDiv.className = "category";
      categoryDiv.innerHTML = `<h2>${category === "P" ? "ã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼ˆPï¼‰" : category === "F" ? "è„‚è³ªï¼ˆFï¼‰" : "ç‚­æ°´åŒ–ç‰©ï¼ˆCï¼‰"}</h2>`;
      categories[category].forEach(item => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <label>${item.name}</label>
          <input type="number" data-name="${item.name}" data-cal="${item.kcal}" data-p="${item.p}" data-f="${item.f}" data-c="${item.c}">
          <div class="result"></div>
          <div class="food-action-buttons">
            <button onclick="editFood('${item.name}')">ç·¨é›†</button>
            <button onclick="deleteFood('${item.name}')">å‰Šé™¤</button>
          </div>
        `;
        categoryDiv.appendChild(div);
      });
      foodGrid.appendChild(categoryDiv);
    });

    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener("input", updateSummary);
    });
    updateSummary();
  }

  // æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼ãªã©ã‚’æ›´æ–°
  function updateSummary() {
    let totalCal = 0, totalP = 0, totalF = 0, totalC = 0;

    document.querySelectorAll('.card').forEach(card => {
      const input = card.querySelector('input');
      const result = card.querySelector('.result');
      const gram = parseFloat(input.value) || 0;
      const cal = parseFloat(input.dataset.cal);
      const p = parseFloat(input.dataset.p);
      const f = parseFloat(input.dataset.f);
      const c = parseFloat(input.dataset.c);

      const kcal = gram * cal;
      const prot = gram * p;
      const fat = gram * f;
      const carb = gram * c;

      result.textContent = `ã“ã®å“ç›®: ${kcal.toFixed(2)} kcalï½œP: ${prot.toFixed(2)}ï½œF: ${fat.toFixed(2)}ï½œC: ${carb.toFixed(2)}`;

      totalCal += kcal;
      totalP += prot;
      totalF += fat;
      totalC += carb;
    });

    document.getElementById("summary").textContent =
      `âœ… ç·æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼: ${totalCal.toFixed(2)} kcalï½œP: ${totalP.toFixed(2)} gï½œF: ${totalF.toFixed(2)} gï½œC: ${totalC.toFixed(2)} g`;

    let warning = "";
    if (totalP > targets.protein) warning += `âš  ã‚¿ãƒ³ãƒ‘ã‚¯è³ªãŒ ${(totalP - targets.protein).toFixed(2)} g ã‚ªãƒ¼ãƒãƒ¼\n`;
    if (totalF > targets.fat) warning += `âš  è„‚è³ªãŒ ${(totalF - targets.fat).toFixed(2)} g ã‚ªãƒ¼ãƒãƒ¼\n`;
    if (totalC > targets.carb) warning += `âš  ç‚­æ°´åŒ–ç‰©ãŒ ${(totalC - targets.carb).toFixed(2)} g ã‚ªãƒ¼ãƒãƒ¼`;

    document.getElementById("warning").textContent = warning;
  }

  // æˆ»ã‚‹ãƒœã‚¿ãƒ³
  function goBack() {
    window.history.back();
  }

  // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®è¿½åŠ 
  const backButton = document.createElement('button');
  backButton.textContent = 'â† æˆ»ã‚‹';
  backButton.classList.add('back-button');
  backButton.onclick = goBack;
  document.body.appendChild(backButton);

  // é£Ÿå“ã®ç·¨é›†
  function editFood(name) {
    const foods = JSON.parse(localStorage.getItem("foodItems") || "[]");
    const food = foods.find(f => f.name === name);
    if (food) {
      document.getElementById("foodName").value = food.name;
      document.getElementById("foodKcal").value = food.kcal;
      document.getElementById("foodP").value = food.p;
      document.getElementById("foodF").value = food.f;
      document.getElementById("foodC").value = food.c;
      document.getElementById("foodCategory").value = food.category;
      openPopup();
      deleteFood(name); // å‰Šé™¤ã—ãŸä¸Šã§ç·¨é›†ã‚’è¡Œã†
    }
  }

  // é£Ÿå“ã®å‰Šé™¤
  function deleteFood(name) {
    let foods = JSON.parse(localStorage.getItem("foodItems") || "[]");
    foods = foods.filter(f => f.name !== name);
    localStorage.setItem("foodItems", JSON.stringify(foods));
    loadFoods(); // é£Ÿå“ãƒªã‚¹ãƒˆã‚’å†åº¦èª­ã¿è¾¼ã‚€
  }

  // é£Ÿå“ã®ä¿å­˜
  function saveFoods() {
    const editGrid = document.getElementById("edit-grid");
    const data = [];
    editGrid.querySelectorAll(".edit-card").forEach(card => {
      const inputs = card.querySelectorAll("input");
      const select = card.querySelector("select");
      const name = inputs[0].value.trim();
      if (name !== "") {
        data.push({
          name: name,
          kcal: parseFloat(inputs[1].value),
          p: parseFloat(inputs[2].value),
          f: parseFloat(inputs[3].value),
          c: parseFloat(inputs[4].value),
          category: select.value
        });
      }
    });
    localStorage.setItem("foodItems", JSON.stringify(data));
    alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
    loadFoods();
  }

  // é£Ÿå“ãƒªã‚»ãƒƒãƒˆ
  function resetFoods() {
    if (confirm("ã™ã¹ã¦ã®é£Ÿå“ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      localStorage.removeItem("foodItems");
      loadFoods();
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    updateUserSelect();
    loadFoods();
  });

</script>

</body>
</html>
